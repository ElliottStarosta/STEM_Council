<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>STEM Council Admin</title>
    <link
      href="https://cdn.jsdelivr.net/npm/remixicon@4.6.0/fonts/remixicon.css"
      rel="stylesheet"
    />
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        overflow: hidden;
        background: #0a0a0a;
      }

      /* Admin Interface */
      .admin-container {
        height: 100vh;
        display: flex;
        flex-direction: column;
      }

      /* Toolbar */
      .admin-toolbar {
        background: #1a1a1a;
        border-bottom: 1px solid #333;
        padding: 12px 20px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 20px;
        z-index: 100;
      }

      .toolbar-left {
        display: flex;
        align-items: center;
        gap: 20px;
      }

      .admin-logo {
        font-size: 18px;
        font-weight: 700;
        color: #42a64c;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .edit-mode-toggle {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px 16px;
        background: #2a2a2a;
        border-radius: 8px;
        border: 1px solid #3a3a3a;
      }

      .toggle-switch {
        position: relative;
        width: 44px;
        height: 24px;
        background: #3a3a3a;
        border-radius: 12px;
        cursor: pointer;
        transition: background 0.3s;
      }

      .toggle-switch.active {
        background: #42a64c;
      }

      .toggle-switch::after {
        content: "";
        position: absolute;
        width: 18px;
        height: 18px;
        background: white;
        border-radius: 50%;
        top: 3px;
        left: 3px;
        transition: transform 0.3s;
      }

      .toggle-switch.active::after {
        transform: translateX(20px);
      }

      .toggle-label {
        color: #aaa;
        font-size: 14px;
      }

      .toolbar-actions {
        display: flex;
        gap: 12px;
      }

      .toolbar-btn {
        padding: 8px 16px;
        border-radius: 6px;
        border: none;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 6px;
        transition: all 0.2s;
      }

      .btn-save {
        background: #42a64c;
        color: white;
      }

      .btn-save:hover:not(:disabled) {
        background: #389342;
        transform: translateY(-1px);
      }

      .btn-save:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .btn-cancel {
        background: #3a3a3a;
        color: white;
      }

      .btn-cancel:hover {
        background: #4a4a4a;
      }

      .btn-logout {
        background: transparent;
        color: #ff4444;
        border: 1px solid #ff4444;
      }

      .btn-logout:hover {
        background: #ff4444;
        color: white;
      }

      .changes-indicator {
        padding: 6px 12px;
        background: #ff9800;
        color: white;
        border-radius: 6px;
        font-size: 13px;
        font-weight: 600;
      }

      /* Content Area */
      .content-area {
        flex: 1;
        position: relative;
        overflow: hidden;
      }

      .site-iframe {
        width: 100%;
        height: 100%;
        border: none;
        background: white;
      }

      /* Edit Overlay */
      .edit-overlay {
        position: fixed;
        inset: 0;
        pointer-events: none;
        z-index: 50;
        top: 53px;
      }

      .editable-highlight {
        position: absolute;
        border: 2px dashed #42a64c;
        background: rgba(66, 166, 76, 0.1);
        cursor: pointer;
        pointer-events: auto;
        transition: all 0.2s;
        border-radius: 4px;
      }

      .editable-highlight:hover {
        background: rgba(66, 166, 76, 0.2);
        border-style: solid;
      }

      .edit-button {
        position: absolute;
        top: -12px;
        right: -12px;
        width: 28px;
        height: 28px;
        background: #42a64c;
        border-radius: 50%;
        border: 2px solid white;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      }

      .edit-button i {
        color: white;
        font-size: 14px;
      }

      /* Edit Modal */
      .edit-modal {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 200;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s;
      }

      .edit-modal.active {
        opacity: 1;
        visibility: visible;
      }

      .modal-content {
        background: #1a1a1a;
        border-radius: 12px;
        width: 90%;
        max-width: 600px;
        max-height: 80vh;
        overflow: auto;
        padding: 24px;
        color: white;
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 16px;
        border-bottom: 1px solid #333;
      }

      .modal-title {
        font-size: 20px;
        font-weight: 600;
      }

      .modal-close {
        background: transparent;
        border: none;
        color: #aaa;
        font-size: 24px;
        cursor: pointer;
        padding: 0;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 4px;
      }

      .modal-close:hover {
        background: #2a2a2a;
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-label {
        display: block;
        margin-bottom: 8px;
        font-size: 14px;
        font-weight: 500;
        color: #aaa;
      }

      .form-input,
      .form-textarea {
        width: 100%;
        padding: 12px;
        background: #2a2a2a;
        border: 1px solid #3a3a3a;
        border-radius: 6px;
        color: white;
        font-size: 14px;
        font-family: inherit;
      }

      .form-textarea {
        min-height: 120px;
        resize: vertical;
      }

      .form-input:focus,
      .form-textarea:focus {
        outline: none;
        border-color: #42a64c;
      }

      .modal-actions {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
        margin-top: 24px;
        padding-top: 16px;
        border-top: 1px solid #333;
      }

      /* Status Messages */
      .status-message {
        position: fixed;
        bottom: 20px;
        right: 20px;
        padding: 12px 20px;
        background: #2a2a2a;
        border-radius: 8px;
        color: white;
        display: flex;
        align-items: center;
        gap: 10px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        z-index: 300;
        transform: translateY(100px);
        opacity: 0;
        transition: all 0.3s;
      }

      .status-message.visible {
        transform: translateY(0);
        opacity: 1;
      }

      .status-message.success {
        background: #42a64c;
      }

      .status-message.error {
        background: #ff4444;
      }

      .status-message.info {
        background: #2196f3;
      }
    </style>
  </head>
  <body>
    <!-- Admin Interface -->
    <div class="admin-container" id="adminContainer">
      <!-- Toolbar -->
      <div class="admin-toolbar">
        <div class="toolbar-left">
          <div class="admin-logo">
            <i class="ri-dashboard-line"></i>
            STEM Council Admin
          </div>
          <div class="edit-mode-toggle">
            <div class="toggle-switch" id="editModeToggle"></div>
            <span class="toggle-label">Edit Mode</span>
          </div>
          <div
            class="changes-indicator"
            id="changesIndicator"
            style="display: none"
          >
            <i class="ri-alert-line"></i>
            <span id="changesCount">0</span> unsaved changes
          </div>
        </div>
        <div class="toolbar-actions">
          <button
            class="toolbar-btn btn-cancel"
            id="discardBtn"
            style="display: none"
          >
            <i class="ri-close-line"></i>
            Discard
          </button>
          <button class="toolbar-btn btn-save" id="saveBtn" disabled>
            <i class="ri-save-line"></i>
            Save Changes
          </button>
          <button class="toolbar-btn btn-logout" id="logoutBtn">
            <i class="ri-logout-box-line"></i>
            Logout
          </button>
        </div>
      </div>

      <!-- Content Area with iframe -->
      <div class="content-area">
        <iframe class="site-iframe" id="siteIframe" src="/"></iframe>
      </div>

      <!-- Edit Overlay (for highlighting editable regions) -->
      <div class="edit-overlay" id="editOverlay"></div>
    </div>

    <!-- Edit Modal -->
    <div class="edit-modal" id="editModal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">Edit Content</h3>
          <button class="modal-close" id="modalCloseBtn">Ã—</button>
        </div>
        <div id="modalForm"></div>
        <div class="modal-actions">
          <button class="toolbar-btn btn-cancel" id="modalCancelBtn">
            Cancel
          </button>
          <button class="toolbar-btn btn-save" id="modalSaveBtn">Save</button>
        </div>
      </div>
    </div>

    <!-- Status Message -->
    <div class="status-message" id="statusMessage">
      <i class="ri-information-line"></i>
      <span id="statusText"></span>
    </div>

    <script>
      // Admin state
      const adminState = {
        user: null,
        editMode: false,
        pendingChanges: {},
        editableRegions: [],
        currentEdit: null,
      };

      // DOM elements
      const elements = {
        adminContainer: document.getElementById("adminContainer"),
        editModeToggle: document.getElementById("editModeToggle"),
        editOverlay: document.getElementById("editOverlay"),
        siteIframe: document.getElementById("siteIframe"),
        saveBtn: document.getElementById("saveBtn"),
        discardBtn: document.getElementById("discardBtn"),
        logoutBtn: document.getElementById("logoutBtn"),
        changesIndicator: document.getElementById("changesIndicator"),
        changesCount: document.getElementById("changesCount"),
        editModal: document.getElementById("editModal"),
        modalForm: document.getElementById("modalForm"),
        modalSaveBtn: document.getElementById("modalSaveBtn"),
        modalCancelBtn: document.getElementById("modalCancelBtn"),
        modalCloseBtn: document.getElementById("modalCloseBtn"),
        statusMessage: document.getElementById("statusMessage"),
        statusText: document.getElementById("statusText"),
      };

      // Initialize Netlify Identity
      function initAuth() {
        if (!window.netlifyIdentity) {
          showStatus("Authentication service unavailable", "error");
          return;
        }

        netlifyIdentity.on("init", (user) => {
          console.log(
            "Identity initialized:",
            user ? "Authenticated" : "Not authenticated"
          );

          if (!user) {
            // Show Netlify's native login modal
            netlifyIdentity.open();
          } else {
            // User is authenticated
            adminState.user = user;
            showStatus("Authenticated as " + user.email, "success");
          }
        });

        netlifyIdentity.on("login", (user) => {
          console.log("Login successful:", user.email);
          adminState.user = user;
          showStatus("Welcome, " + user.email, "success");
          netlifyIdentity.close();
        });

        netlifyIdentity.on("logout", () => {
          console.log("User logged out");
          window.location.href = "/";
        });

        netlifyIdentity.on("error", (err) => {
          console.error("Identity error:", err);
          showStatus("Authentication error: " + err.message, "error");
        });
      }

      // Initialize iframe integration
      function initIframeIntegration() {
        elements.siteIframe.addEventListener("load", () => {
          console.log("Site loaded in iframe");
          if (adminState.editMode) {
            scanEditableContent();
          }
        });

        // Handle iframe scroll when in edit mode
        elements.siteIframe.addEventListener("load", () => {
          try {
            const iframeWindow = elements.siteIframe.contentWindow;
            if (iframeWindow) {
              iframeWindow.addEventListener(
                "scroll",
                () => {
                  if (adminState.editMode) {
                    updateHighlightPositions();
                  }
                },
                true
              ); // Use capture phase
            }
          } catch (e) {
            console.error("Cannot attach scroll listener:", e);
          }
        });
      }

      // Toggle edit mode
      elements.editModeToggle.addEventListener("click", () => {
        adminState.editMode = !adminState.editMode;
        elements.editModeToggle.classList.toggle("active");

        if (adminState.editMode) {
          scanEditableContent();
        } else {
          clearEditableHighlights();
        }
      });

      // Content path mapping for different sections
      const contentMapping = {
        "hero-description": { file: "hero.json", field: "description" },
        "hero-title": { file: "hero.json", field: "title" },
        "about-description": { file: "about.json", field: "description" },
        "about-title": { file: "about.json", field: "title" },
        "contact-subtitle": { file: "contact.json", field: "subtitle" },
        "contact-email": { file: "contact.json", field: "email" },
        "mission-statement": { file: "about.json", field: "mission" },
      };

      // Scan for editable content
      function scanEditableContent() {
        try {
          const iframeDoc = elements.siteIframe.contentDocument;
          if (!iframeDoc) {
            showStatus("Cannot access iframe content", "error");
            return;
          }

          clearEditableHighlights();

          // Find all elements with data-editable attribute
          const editableElements =
            iframeDoc.querySelectorAll("[data-editable]");

          if (editableElements.length === 0) {
            showStatus(
              "No editable content found. Add data-editable attributes to your HTML elements.",
              "info"
            );
          }

          editableElements.forEach((el) => {
            createEditableHighlight(el);
          });
        } catch (error) {
          console.error("Cannot access iframe content:", error);
          showStatus(
            "Cannot access site content. Same-origin policy restriction.",
            "error"
          );
        }
      }

      // Create editable highlight
      function createEditableHighlight(element) {
        const iframeWindow = elements.siteIframe.contentWindow;
        const rect = element.getBoundingClientRect();

        const highlight = document.createElement("div");
        highlight.className = "editable-highlight";

        // Position relative to viewport, accounting for iframe scroll
        highlight.style.top = rect.top + 20 + "px"; // 53px = toolbar height
        highlight.style.left = rect.left + "px";
        highlight.style.width = rect.width + "px";
        highlight.style.height = rect.height + "px";

        const editBtn = document.createElement("div");
        editBtn.className = "edit-button";
        editBtn.innerHTML = '<i class="ri-edit-line"></i>';
        highlight.appendChild(editBtn);

        highlight.addEventListener("click", (e) => {
          e.stopPropagation();
          openEditModal(element);
        });

        elements.editOverlay.appendChild(highlight);
        adminState.editableRegions.push({ element, highlight });
      }

      // Update highlight positions on scroll
      function updateHighlightPositions() {
        try {
          adminState.editableRegions.forEach(({ element, highlight }) => {
            const rect = element.getBoundingClientRect();
            highlight.style.top = rect.top + 20 +  "px"; // 53px = toolbar height
            highlight.style.left = rect.left + "px";
            highlight.style.width = rect.width + "px";
            highlight.style.height = rect.height + "px";
          });
        } catch (e) {
          console.error("Error updating positions:", e);
        }
      }

      // Clear editable highlights
      function clearEditableHighlights() {
        elements.editOverlay.innerHTML = "";
        adminState.editableRegions = [];
      }

      // Open edit modal
      function openEditModal(element) {
        const editableId = element.dataset.editable;
        const contentFile = element.dataset.contentFile || "unknown.json";
        const contentField = element.dataset.contentField || "text";
        const currentValue = element.textContent.trim();

        adminState.currentEdit = {
          element,
          editableId,
          contentFile,
          contentField,
          originalValue: currentValue,
        };

        // Build form
        elements.modalForm.innerHTML = `
        <div class="form-group">
          <label class="form-label">File: ${contentFile}</label>
          <label class="form-label">Field: ${contentField}</label>
        </div>
        <div class="form-group">
          <label class="form-label" for="editContent">Content</label>
          <textarea class="form-textarea" id="editContent" rows="6">${currentValue}</textarea>
        </div>
      `;

        elements.editModal.classList.add("active");
        document.getElementById("editContent").focus();
      }

      // Close edit modal
      function closeEditModal() {
        elements.editModal.classList.remove("active");
        adminState.currentEdit = null;
      }

      elements.modalCloseBtn.addEventListener("click", closeEditModal);
      elements.modalCancelBtn.addEventListener("click", closeEditModal);

      // Save edit from modal
      elements.modalSaveBtn.addEventListener("click", () => {
        const newValue = document.getElementById("editContent").value.trim();

        if (
          adminState.currentEdit &&
          newValue !== adminState.currentEdit.originalValue
        ) {
          // Update the visual element
          adminState.currentEdit.element.textContent = newValue;

          // Track the change
          const changeKey = `${adminState.currentEdit.contentFile}:${adminState.currentEdit.contentField}`;
          adminState.pendingChanges[changeKey] = {
            file: adminState.currentEdit.contentFile,
            field: adminState.currentEdit.contentField,
            value: newValue,
            originalValue: adminState.currentEdit.originalValue,
          };

          updateChangesUI();
          showStatus(
            'Change recorded. Click "Save Changes" to commit.',
            "success"
          );
        }

        closeEditModal();
      });

      // Update changes UI
      function updateChangesUI() {
        const count = Object.keys(adminState.pendingChanges).length;
        elements.changesCount.textContent = count;
        elements.changesIndicator.style.display = count > 0 ? "flex" : "none";
        elements.discardBtn.style.display = count > 0 ? "flex" : "none";
        elements.saveBtn.disabled = count === 0;
      }

      // Discard changes
      elements.discardBtn.addEventListener("click", () => {
        if (confirm("Discard all unsaved changes?")) {
          adminState.pendingChanges = {};
          updateChangesUI();
          elements.siteIframe.contentWindow.location.reload();
          showStatus("Changes discarded", "success");
        }
      });

      // Save changes to GitHub via Netlify Function
      elements.saveBtn.addEventListener("click", async () => {
        if (Object.keys(adminState.pendingChanges).length === 0) return;

        if (!adminState.user) {
          showStatus("You must be logged in to save changes", "error");
          return;
        }

        elements.saveBtn.disabled = true;
        elements.saveBtn.innerHTML =
          '<i class="ri-loader-4-line"></i> Saving...';

        try {
          // Get user token
          const token = adminState.user.token.access_token;

          // Prepare changes for API
          const changesArray = Object.values(adminState.pendingChanges).map(
            (change) => ({
              file: change.file,
              field: change.field,
              value: change.value,
            })
          );

          // Call Netlify Function
          const response = await fetch("/.netlify/functions/save-content", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify({
              changes: changesArray,
              user: adminState.user.email,
            }),
          });

          if (!response.ok) {
            const error = await response.json();
            throw new Error(error.message || "Failed to save changes");
          }

          const result = await response.json();
          console.log("Save result:", result);

          adminState.pendingChanges = {};
          updateChangesUI();
          showStatus("Changes saved and pushed to GitHub!", "success");

          // Reload iframe to show updated content
          setTimeout(() => {
            elements.siteIframe.contentWindow.location.reload();
          }, 1000);
        } catch (error) {
          console.error("Save error:", error);
          showStatus("Failed to save: " + error.message, "error");
        } finally {
          elements.saveBtn.disabled = false;
          elements.saveBtn.innerHTML =
            '<i class="ri-save-line"></i> Save Changes';
        }
      });

      // Logout
      elements.logoutBtn.addEventListener("click", () => {
        if (Object.keys(adminState.pendingChanges).length > 0) {
          if (
            !confirm(
              "You have unsaved changes. Are you sure you want to logout?"
            )
          ) {
            return;
          }
        }
        netlifyIdentity.logout();
      });

      // Show status message
      function showStatus(message, type = "success") {
        elements.statusText.textContent = message;
        elements.statusMessage.className = `status-message ${type} visible`;

        setTimeout(() => {
          elements.statusMessage.classList.remove("visible");
        }, 4000);
      }

      // Initialize
      initAuth();
      initIframeIntegration();
    </script>
  </body>
</html>
